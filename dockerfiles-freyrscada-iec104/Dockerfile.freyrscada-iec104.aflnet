FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --fix-missing \
    build-essential git wget autoconf libtool pkg-config make automake gcc g++ \
    python3 python3-pip patch vim graphviz-dev libcap-dev libcurl4-openssl-dev \
    libjson-c-dev libpcre2-dev tmux tcpdump watch net-tools iputils-ping \
    iproute2 procps clang llvm llvm-10 llvm-10-tools llvm-10-runtime unzip

WORKDIR /opt/fuzzing

# Clone AFLNet using SSH
RUN --mount=type=ssh \
    mkdir -p ~/.ssh && \
    ssh-keyscan github.com >> ~/.ssh/known_hosts && \
    git clone git@github.com:susu3/aflnet-ICS-.git aflnet-ICS- && \
    cd aflnet-ICS- && \
    make clean all && \
    cd llvm_mode && make

ENV PATH="/opt/fuzzing/aflnet-ICS-:$PATH"
ENV AFL_PATH="/opt/fuzzing/aflnet-ICS-"
ENV AFL_USE_ASAN=1

# Clone FreyrSCADA IEC104
RUN git clone https://github.com/FreyrSCADA/IEC-60870-5-104.git freyrscada-iec104 && \
    cd freyrscada-iec104/IEC104-Linux-SDK && \
    unzip IEC104-LinuxSDK.zip

# Apply patch (包含 Makefile 和源代码修改)
COPY dockerfiles-freyrscada-iec104/freyrscada-iec104-fuzzing.patch /tmp/
RUN cd /opt/fuzzing/freyrscada-iec104/IEC104-Linux-SDK/LinuxSDK/x86_64 && \
    sed -i 's/\r$//' source/simpleIEC104server.c project/iec104servertest.mak && \
    patch -p1 < /tmp/freyrscada-iec104-fuzzing.patch && \
    rm /tmp/freyrscada-iec104-fuzzing.patch

# Compile
RUN cd /opt/fuzzing/freyrscada-iec104/IEC104-Linux-SDK/LinuxSDK/x86_64/project && \
    make -f iec104servertest.mak clean && \
    make -f iec104servertest.mak

RUN mkdir -p /opt/fuzzing/results
RUN useradd -m -s /bin/bash fuzzer && chown -R fuzzer:fuzzer /opt/fuzzing
USER fuzzer

RUN echo '#!/bin/bash\n\
RUN_NUM=${RUN_NUM:-1}\n\
OUTPUT_DIR="/opt/fuzzing/results/freyrscada-iec104-aflnet-${RUN_NUM}"\n\
echo "Starting AFLNet fuzzing for FreyrSCADA IEC104 run #${RUN_NUM}"\n\
echo "Output directory: ${OUTPUT_DIR}"\n\
export ASAN_OPTIONS="abort_on_error=1:detect_leaks=0:symbolize=0:allocator_may_return_null=1"\n\
cd /opt/fuzzing/freyrscada-iec104/IEC104-Linux-SDK/LinuxSDK/x86_64/output && \\\n\
afl-fuzz -d -m none -t 5000+ -i /opt/fuzzing/aflnet-ICS-/tutorials/iec104/in-iec104 \\\n\
  -o "${OUTPUT_DIR}" \\\n\
  -N tcp://127.0.0.1/2404 -P IEC104 \\\n\
  -D 10000 -q 3 -s 3 -E -K -R ./iec104servertest 2404' > /opt/fuzzing/start_fuzzing.sh && \
    chmod +x /opt/fuzzing/start_fuzzing.sh

CMD ["/opt/fuzzing/start_fuzzing.sh"]

