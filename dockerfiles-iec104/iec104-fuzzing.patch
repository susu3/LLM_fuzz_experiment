--- IEC104/test/main.c.orig	2025-12-11 15:22:18.833913634 +0800
+++ IEC104/test/main.c	2025-12-11 15:27:10.180836292 +0800
@@ -16,6 +16,7 @@
 #include "errno.h"
 #include "sys.h"
 #include "main.h"
+#include <signal.h>
 
 pthread_mutex_t mutex;
 pthread_mutex_t mutex2;
@@ -61,12 +62,12 @@
 
     int socketfd = (*(int *)arg);
     while(1){
-        //pthread_mutex_lock(&mutex2);
         Iec10x_Scheduled(socketfd);      
         Iec104_StateMachine();
-        //pthread_mutex_lock(&mutex2);
+        usleep(10000);                  // é™ä½Ž CPU å ç”¨
+        pthread_testcancel();           // âœ… ðŸ”¥ å…è®¸ä¸»çº¿ç¨‹ cancel å®ƒ
     }
-    return ((void *)0); 
+    return NULL;
 }
 
 
@@ -76,18 +77,15 @@
     int sin_size,on=1;
     char Iec104_RecvBuf[MAXLINE];
     uint16_t Iec104_RecvLen;
-    pthread_t tid1,tid2; 
-    int err;  
-    void *tret;  
+    pthread_t tid1; 
+    int err;
 
-    unsigned int addr =  inet_addr("0.0.0.0");
     unsigned short portnum=((PSocketArg_T)arg)->port;
     
-    int socketfd = 0;
     sfp = socket(AF_INET, SOCK_STREAM, 0);
     if(-1 == sfp){
         printf("socket fail ! \r\n");
-        return;
+        return NULL;
     }
 
     LOG("Iec104 Socket Ok(%d) !\r\n",portnum);
@@ -95,55 +93,55 @@
     
     bzero(&s_add,sizeof(struct sockaddr_in));
     s_add.sin_family=AF_INET;
-    s_add.sin_addr.s_addr=htonl(((PSocketArg_T)arg)->addr);
-    s_add.sin_addr.s_addr=htonl(INADDR_ANY);
+    s_add.sin_addr.s_addr = ((PSocketArg_T)arg)->addr;  // should be 127.0.0.1
     s_add.sin_port=htons(portnum);
 
     if(-1 == bind(sfp,(struct sockaddr *)(&s_add), sizeof(struct sockaddr))){
-        printf("Bind fail, Port(%d), err(%d)  !\r\n",portnum, errno);
-        //printf("Bind fail, Port(%d), err  !\r\n",portnum);
-        return;
+        printf("Bind fail, Port(%d), err(%d)!\r\n",portnum, errno);
+        return NULL;
     }
-    LOG("Iec104 Bind Ok(%d) !\r\n",portnum);
+    LOG("Iec104 Bind Ok(%d)!\r\n",portnum);
 
     if(-1 == listen(sfp,5)){
         printf("listen fail (%d)!\r\n",portnum);
-        return;
+        return NULL;
     }
     printf("Iec104 Listen Ok(%d)\r\n", portnum);
 
-    while(1){
-        sin_size = sizeof(struct sockaddr_in);
+    sin_size = sizeof(struct sockaddr_in);
 
-        nfp = accept(sfp, (struct sockaddr *)(&c_add), &sin_size);
-        if(-1 == nfp){
-            printf("accept fail !\r\n");
-            return;
-        }
-        
-        err=pthread_create(&tid1,NULL,Iec104_Task,&nfp);
-        if(err!=0)  {  
-                LOG("pthread_create error:%s\n",strerror(err));  
-                exit(-1);  
-        } 
-        
-        printf("Accept ok!\r\nServer start get connect from %#x : %#x\r\n",ntohl(c_add.sin_addr.s_addr),ntohs(c_add.sin_port));
-        while(1){
-            Iec104_RecvLen = read(nfp,Iec104_RecvBuf,MAXLINE);
-            if(Iec104_RecvLen <= 0 || Iec104_RecvLen>1500){
-                //printf("the other side has been closed (%d).\n",Iec104_RecvLen);
-                continue;
-            }
-            LOG("#####################received \n");
+    nfp = accept(sfp, (struct sockaddr *)(&c_add), &sin_size);
+    if(-1 == nfp){
+        printf("accept fail !\r\n");
+        return NULL;
+    }
+    printf("=== [Server] accepted connection ===\n");
 
-            DumpHEX(Iec104_RecvBuf,Iec104_RecvLen);
-            Iex104_Receive(Iec104_RecvBuf, Iec104_RecvLen);
+    // å¯åŠ¨å­çº¿ç¨‹
+    err = pthread_create(&tid1, NULL, Iec104_Task, &nfp);
+    if (err != 0) {
+        LOG("pthread_create error:%s\n", strerror(err));
+        exit(-1);
+    }
 
-        }
-        close(nfp);
+    // ä¸»çº¿ç¨‹åªå¤„ç†ä¸€æ¬¡ seed
+    printf("=== [Server] waiting for read()\n");
+    Iec104_RecvLen = read(nfp, Iec104_RecvBuf, MAXLINE);
+    printf("=== [Server] read() returned %d bytes\n", Iec104_RecvLen);
+
+    if (Iec104_RecvLen > 0 && Iec104_RecvLen <= 1500) {
+        DumpHEX(Iec104_RecvBuf, Iec104_RecvLen);
+        Iex104_Receive(Iec104_RecvBuf, Iec104_RecvLen);
+        printf("[+] Main thread finished read(), preparing to exit\n");
     }
+
+    usleep(100000);                     // ç•™ä¸€ç‚¹æ—¶é—´å¤„ç†çŠ¶æ€
+    pthread_cancel(tid1);              //
+    pthread_join(tid1, NULL);          //
+
+    close(nfp);
     close(sfp);
-    return;
+    exit(0);
 }
 
 uint32_t sta_temp = 0;
@@ -155,7 +153,8 @@
     struct sockaddr_in    servaddr;  
     //uint8_t *dstip = "220.160.62.206";
     int err;
-    uint8_t *dstip = "192.168.1.114";
+    //uint8_t *dstip = "192.168.1.114";
+    uint8_t *dstip = "127.0.0.1";
     pthread_t tid1; 
 
     int staid = StaCount++;
@@ -179,7 +178,7 @@
 
     memset(&servaddr, 0, sizeof(servaddr));  
     servaddr.sin_family = AF_INET;  
-    servaddr.sin_port = htons(6666);  
+    servaddr.sin_port = htons(2404);  
     if(inet_pton(AF_INET, dstip, &servaddr.sin_addr) <= 0){  
         printf("inet_pton error for %s\n",dstip);  
         exit(0);  
@@ -187,7 +186,7 @@
 
     if(connect(socketfd, (struct sockaddr*)&servaddr, sizeof(servaddr)) < 0){  
         printf("connect error: %s(errno: %d)  num(%d)\n",strerror(errno),errno,sta_temp++);  
-        return; 
+        return NULL; 
     }
     //LOG("sta(%d) Connect OK \n",);
 
@@ -207,7 +206,8 @@
     }
     close(socketfd); 
  
-    exit(0);  
+    fflush(stdout);
+    kill(getpid(), SIGKILL);
 }
 
 
@@ -220,14 +220,14 @@
   unsigned int addr1 = 0,addr2 = 0;
   int opt;  
   char *optstring = "p:d:n:m:h";  
-  unsigned short port1 = 10000;
+  unsigned short port1 = 2404;
   unsigned short port2 = 10001;
-  addr1 =  inet_addr("192.168.1.114");
+  addr1 =  inet_addr("127.0.0.1");
   addr2 =  inet_addr("192.168.1.114");
   uint32_t Addr = 0,i;
   void *ptemp = NULL;
   
-  Arg1.port = 10000;
+  Arg1.port = 2404;
   Arg1.addr = addr1;
   
   uint8_t mode = SOCKET_MODE_CLIENT;
@@ -239,6 +239,9 @@
  
   Stm32f103RegisterIec10x(); 
 
+  mode = SOCKET_MODE_SERVER;
+
+  /*
   while ((opt = getopt(argc, argv, optstring)) != -1){ 
   #if 0 
     printf("opt = %c\n", opt);  
@@ -285,7 +288,8 @@
         break;
     }
   }  
-  
+  */
+
   LOG("mode :(%d), port: (%d), ip: (%s), station num: (%d) \n",mode, Port,DstIp,NumSta);   
   
   pthread_mutex_init(&mutex,NULL);
@@ -298,11 +302,12 @@
   
   if(mode == SOCKET_MODE_SERVER){
     LOG("Iec104 Server Mode \n");
-    err=pthread_create(&tid1,NULL,Iec104_main,&Arg1);
-    if(err!=0)  {  
-      LOG("pthread_create error:%s\n",strerror(err));  
-      exit(-1);  
-    } 
+    Iec104_main(&Arg1);
+    return 0;
+    // if(err!=0)  {  
+    //   LOG("pthread_create error:%s\n",strerror(err));  
+    //   exit(-1);  
+    // } 
   }else if(mode == SOCKET_MODE_CLIENT){
     LOG("Iec104 Client Mode \n");
     for(i=0; i<NumSta; i++){
@@ -315,7 +320,7 @@
       } 
     }
   }
-  while(1);
+  //while(1);
 
   return 0;
-}
\ No newline at end of file
+}
